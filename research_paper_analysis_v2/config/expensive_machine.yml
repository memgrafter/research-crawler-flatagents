spec: flatmachine
spec_version: "1.0.0"

data:
  name: expensive-pipeline
  profiles: ./profiles.yml

  persistence:
    enabled: true
    backend: local

  hooks:
    module: research_paper_analysis_v2.hooks
    class: V2Hooks

  settings:
    max_steps: 15

  context:
    # Identity (passed by runner from DB)
    arxiv_id: input.arxiv_id
    execution_id: input.execution_id
    paper_id: input.paper_id
    source_url: input.source_url
    title: input.title
    authors: input.authors
    abstract: input.abstract

    # From prep phase
    section_text: input.section_text
    reference_count: input.reference_count
    key_outcome: input.key_outcome
    corpus_signals: input.corpus_signals
    corpus_neighbors: input.corpus_neighbors

    # Token targets
    token_target_why: "500-800"
    token_target_reproduction: "220-380"
    token_target_open_questions: "120-220"

    # Generated by expensive agents (populated by unpack)
    why_hypotheses: null
    reproduction_notes: null
    open_questions: null

  machines:
    why_hypothesis_machine: ./why_hypothesis_machine.yml
    reproduction_machine: ./reproduction_machine.yml
    open_questions_machine: ./open_questions_machine.yml

  states:
    start:
      type: initial
      transitions:
        - to: parallel_expensive_writers

    # All 3 expensive calls in parallel â€” pure pony-alpha
    parallel_expensive_writers:
      machine: [why_hypothesis_machine, reproduction_machine, open_questions_machine]
      mode: settled
      input:
        title: context.title
        key_outcome: context.key_outcome
        abstract: context.abstract
        section_text: context.section_text
        reference_count: context.reference_count
        corpus_signals: context.corpus_signals
        corpus_neighbors: context.corpus_neighbors
        token_target_why: context.token_target_why
        token_target_reproduction: context.token_target_reproduction
        token_target_open_questions: context.token_target_open_questions
      output_to_context:
        parallel_raw: output
      on_error: expensive_failed
      transitions:
        - to: unpack_expensive_results

    unpack_expensive_results:
      action: unpack_expensive_results
      transitions:
        - to: save_expensive_result

    save_expensive_result:
      action: save_expensive_result
      transitions:
        - to: done

    done:
      type: final
      output:
        arxiv_id: context.arxiv_id
        execution_id: context.execution_id
        why_hypotheses: context.why_hypotheses
        reproduction_notes: context.reproduction_notes
        open_questions: context.open_questions

    expensive_failed:
      action: mark_execution_failed
      transitions:
        - to: failed

    failed:
      type: final
      output:
        error: context.last_error
        arxiv_id: context.arxiv_id
        execution_id: context.execution_id

metadata:
  description: "Expensive pipeline: 3 parallel pony-alpha calls only (why, reproduction, open questions)"
  tags: ["expensive-model", "parallel", "pony-alpha"]
