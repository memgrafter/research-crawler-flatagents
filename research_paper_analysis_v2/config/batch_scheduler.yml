spec: flatmachine
spec_version: "1.0.0"

data:
  name: batch_scheduler_v2

  hooks:
    module: research_paper_analysis_v2.distributed_hooks
    class: DistributedPaperAnalysisHooks

  context:
    max_workers: input.max_workers
    workers_to_spawn: 0
    spawned_count: 0
    spawned_ids: []

  states:
    start:
      type: initial
      transitions:
        - to: get_pool_state

    get_pool_state:
      action: get_pool_state
      output_to_context:
        queue_depth: output.queue_depth
        active_workers: output.active_workers
      transitions:
        - to: calculate_spawn

    calculate_spawn:
      action: calculate_spawn
      output_to_context:
        workers_to_spawn: output.workers_to_spawn
        available_slots: output.available_slots
      transitions:
        - condition: "context.workers_to_spawn > 0"
          to: spawn_workers
        - to: done

    spawn_workers:
      action: spawn_workers
      output_to_context:
        spawned_ids: output.spawned_ids
        spawned_count: output.spawned_count
      transitions:
        - to: done

    done:
      type: final
      output:
        queue_depth: context.queue_depth
        active_workers: context.active_workers
        workers_to_spawn: context.workers_to_spawn
        spawned_count: context.spawned_count
        spawned_ids: context.spawned_ids

metadata:
  description: "Lean v2 scheduler pass that spawns up to max_workers against pending latest-version jobs"