spec: flatmachine
spec_version: "1.0.0"

data:
  name: paper_analysis_worker_v2

  # Single worker that claims one paper from the existing paper_queue,
  # runs the v2 analyzer machine, and writes result via old DB hooks.
  context:
    worker_id: input.worker_id
    rate_limit_agent_states:
      - analyze_paper

  hooks:
    module: research_paper_analysis_v2.distributed_hooks
    class: DistributedPaperAnalysisHooks

  machines:
    analyzer: ./machine.yml

  states:
    start:
      type: initial
      transitions:
        - to: register_worker

    register_worker:
      action: register_worker
      output_to_context:
        registered_at: output.registered_at
      transitions:
        - to: claim_paper

    claim_paper:
      action: claim_paper
      output_to_context:
        queue_id: output.queue_id
        paper_id: output.paper_id
        paper: output.paper
      transitions:
        - condition: "context.paper == None"
          to: no_work
        - to: prepare_paper

    prepare_paper:
      action: prepare_paper
      output_to_context:
        section_text: output.section_text
        reference_count: output.reference_count
        references_sample: output.references_sample
        prepared: output.prepared
      on_error: paper_failed
      transitions:
        - condition: "context.prepared == false"
          to: paper_failed
        - to: analyze_paper

    analyze_paper:
      machine: analyzer
      input:
        worker_id: context.worker_id
        arxiv_id: context.paper.arxiv_id
        source_url: context.paper.source_url
        title: context.paper.title
        authors: context.paper.authors
        abstract: context.paper.abstract
        section_text: context.section_text
        reference_count: context.reference_count
      output_to_context:
        analysis_result: output
      on_error: paper_failed
      transitions:
        - condition: "context.analysis_result.error != None"
          to: paper_failed
        - to: save_result

    save_result:
      action: complete_paper
      transitions:
        - to: deregister

    paper_failed:
      action: fail_paper
      transitions:
        - to: deregister

    deregister:
      action: deregister_worker
      transitions:
        - to: done

    no_work:
      action: deregister_worker
      transitions:
        - to: no_work_final

    no_work_final:
      type: final
      output:
        status: "no_work_available"
        worker_id: context.worker_id

    done:
      type: final
      output:
        queue_id: context.queue_id
        paper_id: context.paper_id
        result: context.analysis_result
        worker_id: context.worker_id

metadata:
  description: "V2 worker using the existing queue/database schema"
