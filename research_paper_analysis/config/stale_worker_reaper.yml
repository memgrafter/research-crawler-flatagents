spec: flatmachine
spec_version: "0.9.0"

data:
  name: stale_worker_reaper
  
  # Finds workers that have missed heartbeats and releases their papers
  
  context:
    stale_threshold_seconds: 120
  
  hooks:
    module: research_paper_analysis.distributed_hooks
    class: DistributedPaperAnalysisHooks
  
  states:
    start:
      type: initial
      transitions:
        - to: find_stale_workers
    
    find_stale_workers:
      action: list_stale_workers
      output_to_context:
        stale_workers: output.workers
        stale_count: output.stale_count
        reaped_count: output.stale_count
      transitions:
        - condition: "context.stale_count == 0"
          to: done
        - to: reap_workers
    
    reap_workers:
      action: reap_workers
      transitions:
        - to: done
    
    done:
      type: final
      output:
        reaped_count: context.reaped_count
        stale_workers: context.stale_workers

metadata:
  description: "Stale worker reaper - finds dead workers and releases their papers"
